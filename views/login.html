<html>
	<head>
		{{- include head.html}}
		<link rel="stylesheet" href="/css/login.css" />
	</head>
	<body>
        <div class="body_wrapper">
            {{- include header.html}}
                <div id="central">
                    <div class="card grey_dark_bg card-wrapper">
                        <div class="" id="login_form">
                            <h1 class="multilang" text="login_title"></h1>
                            <div class="form-group" id="email_sign_in">
                                <label>Email</label>
                                <input type="email" class="form-control" id="email" placeholder="Email" />
                                <span class="help-block" id="email_error_div"></span>
                            </div>
                            <div class="form-group" id="password_sign_in">
                                <label class="multilang" text="login_password"></label>
                                <div class="inline">
                                    <input type="password" class="form-control" id="password" placeholder="Password" />
                                    <p text="login_forgotten" class="multilang link js_redirect_forgotten"></p>
                                </div>
                                <span class="help-block" id="password_error_div"></span>
                            </div>
                            <button text="login_submit" class="btn btn-default multilang" id="login_submit_btn"></button>
                            {{if (err !== 'None') { }}
                                {{=err.message}};
                            {{ } }}
                            <span><p text="login_register" class="multilang link js_redirect_signup"></p></span>
                        </div>
                    </div>
                </div>
            </div>
		{{- include footer.html }}
	</body>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
	<script>
		var emailRE = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
		var passRE = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])\w{6,}$/;

		var onDataLoaded = function () {
			$('#login_submit_btn').click(onLoginClicked);
		}

		var onLoginClicked = function () {
			var testInputData = function (email, passwd) {
				var res;
				if (!emailRE.test(email)) {
					res = {};
					res.emailError = "Wrong email format";
				}
				if (!passRE.test(passwd)) {
					if (!res) {
						res = {};
					}
					res.passwordError = "Wrong password format";
				}
				return res;
			}
			var showEmailError = function (error) {
				$('#email_sign_in').addClass('has-error');
				$('#email_error_div').text(error);
			}
			var showPasswordError = function (error) {
				$('#password_sign_in').addClass('has-error');
				$('#password_error_div').text(error);
			}

			$('#email_sign_in').removeClass('has-error');
			$('#password_sign_in').removeClass('has-error');
			$('#email_error_div').text('');
			$('#password_error_div').text('');

			var email = $('#email').val();
			var pwd = $('#password').val();
			var test_res = testInputData(email, pwd);

			if (test_res) {
				if (test_res.emailError) {
					showEmailError(test_res.emailError);
				}
				if (test_res.passwordError) {
					showPasswordError(test_res.passwordError);
				}
			} else {
				pwd = CryptoJS.SHA1(pwd).toString();
				$.post('/auth', {
					username: email,
					password: pwd
				}, function (data) {
					console.log(data);
					if (data.content && data.content === 'Error') {
						if (data.field === 'email') {
							showEmailError(data.message);
						} else if (data.field === 'pass') {
							showPasswordError(data.message);
						} else if (data.field === 'general') {
							showModalError(data.message);
						}
					} else if (data.redirect) {
						document.location.href = document.location.origin + data.redirect.path + '?lang=' + current_lang;
					}
				});
			}
		}
	</script>
	{{- include scripts.html}}
</html>