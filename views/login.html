<html>
	<head>
		{{- include head.html}}
		<link rel="stylesheet" href="/css/login.css" />
	</head>
	<body>
		{{- include header.html}}
		<div class="row">
			<div id="central" class="col-lg-8 col-lg-offset-2">
				<div class="card grey_dark_bg row">
					<div class="col-lg-4 col-lg-offset-3 col-ms-4 col-ms-offset-3 col-sm-4 col-sm-offset-3 col-xs-12" id="login_form">
						<h1>Login</h1>
						<div class="form-group" id="email_sign_in">
							<label>Email</label>
							<input type="email" class="form-control" id="email" placeholder="Email">
							<span class="help-block" id="email_error_div"></span>
						</div>
						<div class="form-group" id="password_sign_in">
							<label>Password</label>
							<input type="password" class="form-control" id="password" placeholder="Password">
							<span class="help-block" id="password_error_div"></span>
						</div>
						<button class="btn btn-default" id="login_submit_btn">Submit</button>
					</div>
				</div>
			</div>
		</div>
		{{- include footer.html }}
	</body>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
	<script>
		{{if (err !== 'None') { }}
			alert('{{-JSON.stringify(err)}}');
		{{ } }}

		var emailRE = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
		var passRE = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])\w{6,}$/;
		var onDataLoaded = function () {
			$('#login_submit_btn').click(login);
			$('#central').css('bottom', 0);
		}
		var login = function () {
			var testInputData = function (email, passwd) {
				var res;
				if (!emailRE.test(email)) {
					res = {};
					res.emailError = "Wrong email format";
				}
				if (!passRE.test(passwd)) {
					if (!res) {
						res = {};
					}
					res.passwordError = "Wrong password format";
				}
				return res;
			}
			var showEmailError = function (error) {
				$('#email_sign_in').addClass('has-error');
				$('#email_error_div').text(error);
			}
			var showPasswordError = function (error) {
				$('#password_sign_in').addClass('has-error');
				$('#password_error_div').text(error);
			}
			$('#email_sign_in').removeClass('has-error');
			$('#password_sign_in').removeClass('has-error');
			$('#email_error_div').text('');
			$('#password_error_div').text('');
			var email = $('#email').val();
			var pwd = $('#password').val();
			var test_res = testInputData(email, pwd);
			if (test_res) {
				if (test_res.emailError) {
					showEmailError(test_res.emailError);
				}
				if (test_res.passwordError) {
					showPasswordError(test_res.passwordError);
				}
			} else {
				pwd = CryptoJS.SHA1(pwd).toString();
				$('#login_form').block({
					message: "Loading..."
				});
				$.post('/auth', {
					username: email,
					password: pwd
				}, function (data) {
					$('#login_form').unblock();
					if (data.err) {
						if (data.err.field === 'email') {
							showEmailError(data.err.error_message);
						} else if (data.err.field === 'pass') {
							showPasswordError(data.err.error_message);
						} else if (data.err.field === 'general') {
							showModalError(data.err.error_message);
						}
					} else if (data.redirect) {
						document.location.href = document.location.origin + data.redirect.path + '?lang=' + current_lang;
					}
				});
			}
		}
	</script>
	{{- include scripts.html}}
</html>